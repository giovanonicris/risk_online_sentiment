name: Daily Sentiment Update
on:
  schedule:
    - cron: "0 7 * * *" # runs at 7am UTC (3am EST)
  workflow_dispatch:
    inputs:
      risk_type:
        description: "Which risk type to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - enterprise
          - emerging
      debug_mode:
        description: "Enable debug mode (true/false)"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  process-enterprise:
    runs-on: ubuntu-latest
    if: github.event.inputs.risk_type != 'emerging' || inputs.risk_type == 'all'
    strategy:
      matrix:
        risk_type: ['enterprise']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}-py3.12
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install lxml[html_clean] newspaper3k vaderSentiment googlenewsdecoder keybert
      - name: Run ${{ matrix.risk_type }} sentiment processor
        env:
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          MAX_ARTICLES_PER_TERM: 20
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
        run: |
          python RiskNewsScraper.py --risk-type ${{ matrix.risk_type }} 
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.risk_type }}-data
          path: |
            output/${{ matrix.risk_type }}_risks_online_sentiment.csv

  process-emerging:
    runs-on: ubuntu-latest
    if: github.event.inputs.risk_type != 'enterprise' || inputs.risk_type == 'all'
    strategy:
      matrix:
        risk_type: ['emerging']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}-py3.12
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install lxml[html_clean] newspaper3k vaderSentiment googlenewsdecoder keybert
      - name: Run ${{ matrix.risk_type }} sentiment processor
        env:
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          MAX_ARTICLES_PER_TERM: 20
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
        run: |
          python RiskNewsScraper.py --risk-type ${{ matrix.risk_type }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.risk_type }}-data
          path: |
            output/${{ matrix.risk_type }}_risks_online_sentiment.csv

  publish-data:
    needs: [process-data, process-emerging]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          ref: main
      - name: Download artifacts
        run: |
          # download enterprise
          mkdir -p output
          actions/download-artifact --name enterprise-data --path output 2>/dev/null || echo "no enterprise data"
          # download emerging
          actions/download-artifact --name emerging-data --path output 2>/dev/null || echo "no emerging data"
      - name: Merge and commit CSVs
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git checkout main
          mkdir -p output
          # enterprise merge (if exists)
          if [ -f "output/enterprise_risks_online_sentiment.csv" ]; then
            cp "output/enterprise_risks_online_sentiment.csv" output/enterprise_risks_online_sentiment.csv
          fi
          # emerging merge (if exists)
          if [ -f "output/emerging_risks_online_sentiment.csv" ]; then
            cp "output/emerging_risks_online_sentiment.csv" output/emerging_risks_online_sentiment.csv
          fi
          # add and commit changes
          git add output/*.csv
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update sentiment data - $(date +%Y-%m-%d)"
            git push
          fi
